### Nginx

#### 1.简单介绍一下 Nginx

Nginx是一款轻量级的Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器。 Nginx主要提供**反向代理、负载均衡、静态资源服务**等服务。

**反向代理**

谈到反向代理，就不得不提一下正向代理。无论是正向代理，还是反向代理，说到底，就是代理模式的衍生版本罢了

- **正向代理**：某些情况下，代理我们用户去访问服务器，需要用户手动的设置代理服务器的ip和端口号。正向代理比较常见的一个例子就是 VPN了。 
- **反向代理**： 是用来代理服务器的，代理我们要访问的目标服务器。代理服务器接受请求，然后将请求转发给内部网络的服务器，并将从服务器上得到的结果返回给客户端，此时代理服务器对外就表现为一个服务器。

![30](/Users/wx/project/interview/docs/秘籍/images/30.png)

![31](/Users/wx/project/interview/docs/秘籍/images/31.png)

所以，简单的理解，就是**正向代理是为客户端做代理，代替客户端去访问服务器**，而**反向代理是为服务器做代理，代替服务器接受客户端请求**。也就是说**正向代理屏蔽客户端，反向代理屏蔽服务端**。

**负载均衡**

在高并发情况下需要使用，其原理就是**将并发请求分摊到多个服务器执行，减轻每台服务器的压力，多台服务器(集群)共同完成工作任务，从而提高了数据的吞吐量**。

Nginx支持的**weight轮询（默认）、ip_hash、fair、url_hash**这四种负载均衡调度算法。

负载均衡相比于反向代理更侧重的是将请求分担到多台服务器上去，所以谈论负载均衡只有在提供某服务的服务器大于两台时才有意义。

**静态资源服务器（动静分离）**

动静分离是让动态网站里的动态网页根据一定规则把不变的资源和经常变的资源区分开来，动静资源做好了拆分以后，我们就可以**根据静态资源的特点将其做缓存操作**，这就是网站静态化处理的核心思路。

#### 2.为什么要用Nginx？

（本意是想考察Nginx的优点）

Nginx 有以下5个优点：

1. **高并发、高性能**（这是其他web服务器不具有的）
2. **可扩展性好**（模块化设计，第三方插件生态圈丰富）
3. **高可靠性**（可以在服务器行持续不间断的运行数年）
4. **热部署**（这个功能对于 Nginx 来说特别重要，热部署指可以在不停止 Nginx服务的情况下升级 Nginx）
5. **BSD许可证**（意味着我们可以将源代码下载下来进行修改然后使用自己的版本）

#### 3.Nginx 的四个主要组成部分了解吗?

1. **Nginx 二进制可执行文件**：由各模块源码编译出一个文件 
2. **Nginx.conf 配置文件**：控制Nginx 行为 
3. **acess.log 访问日志**： 记录每一条HTTP请求信息 
4. **error.log 错误日志**:定位问题

#### 4.Nginx为什么那么快？

Nginx之所以性能如此优越，是因为它使用了**多进程 + 异步非阻塞方式（IO 多路复用 epoll）**。

下图是 Nginx 的进程模型：

![32](https://pic2.zhimg.com/v2-9eabd8570ab7ca5500323745b184dc25_r.jpg)

多进程：**一个 Master 进程、多个 Worker 进程，Master 进程管理 Worker 进程**

Nginx 服务器，正常运行过程中：

1. **多进程**：一个 Master 进程、多个 Worker 进程

2. **Master 进程**：管理 Worker 进程

3. 1. 对外接口：接收`外部的操作`（信号）
   2. 对内转发：根据`外部的操作`的不同，通过`信号`管理 Worker
   3. 监控：监控 worker 进程的运行状态，worker 进程异常终止后，自动重启 worker 进程

4. **Worker 进程**：所有 Worker 进程都是平等的

5. 1. 实际处理：网络请求，由 Worker 进程处理；
   2. Worker 进程数量：在 nginx.conf 中配置，一般设置为`核心数`，充分利用 CPU 资源，同时，避免进程数量过多，避免进程竞争 CPU 资源，增加上下文切换的损耗。

![](https://picb.zhimg.com/v2-4f9de4b2763a1388b7eef14444429cce_r.jpg)

HTTP 连接建立和请求处理过程：

1. Nginx 启动时，Master 进程，加载配置文件
2. Master 进程，初始化监听的 socket
3. Master 进程，fork 出多个 Worker 进程
4. Worker 进程，竞争新的连接，获胜方通过三次握手，建立 Socket 连接，并处理请求

Nginx 高性能、高并发：

1. Nginx 采用：**`多进程` + `异步非阻塞`方式（`IO 多路复用` epoll）**

2. 请求的完整过程：

3. 1. 建立连接
   2. 读取请求：解析请求
   3. 处理请求
   4. 响应请求

4. 请求的完整过程，对应到底层，就是：读写 socket 事件

